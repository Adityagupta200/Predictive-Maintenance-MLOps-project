# Builder stage 
FROM python:3.11-slim-bookworm AS builder

WORKDIR /app

RUN set -eux; \
    if [ -f /etc/apt/sources.list ]; then \
      sed -i 's|http://deb.debian.org|https://deb.debian.org|g; s|http://security.debian.org|https://security.debian.org|g' /etc/apt/sources.list; \
    fi; \
    if ls /etc/apt/sources.list.d/*.sources >/dev/null 2>&1; then \
      sed -i 's|http://deb.debian.org|https://deb.debian.org|g; s|http://security.debian.org|https://security.debian.org|g' /etc/apt/sources.list.d/*.sources; \
    fi; \
    apt-get update; \
    apt-get install -y --no-install-recommends build-essential cmake ninja-build; \
    rm -rf /var/lib/apt/lists/*

COPY requirements-api.txt .

# Install into system site-packages so console scripts (e.g., dvc) land in /usr/local/bin
RUN python -m pip install --upgrade pip setuptools wheel && \
    pip install --no-cache-dir -r requirements-api.txt

# Runtime stage 
FROM python:3.11-slim-bookworm

WORKDIR /app

# Runtime OS deps:
# - libgomp1: required by xgboost at runtime
# - bash: required for "set -euo pipefail" in Job scripts
# - git: commonly used by DVC internals; safe to include
RUN apt-get update && apt-get install -y --no-install-recommends \
        libgomp1 \
        bash \
        git \
    && rm -rf /var/lib/apt/lists/*

# Bring in installed deps + console scripts (dvc will be in /usr/local/bin)
COPY --from=builder /usr/local /usr/local

# App code + model
COPY src ./src
COPY models ./models

# DVC metadata so `dvc pull ...` works from /app (as in the initContainer)
COPY dvc.yaml ./dvc.yaml
COPY dvc.lock ./dvc.lock
COPY .dvc/ ./.dvc/
COPY params.yaml ./params.yaml
COPY CMaps ./CMaps

ENV PYTHONPATH=/app/src
ENV PYTHONUNBUFFERED=1

EXPOSE 8000
CMD ["uvicorn", "api.main:app", "--host", "0.0.0.0", "--port", "8000"]
