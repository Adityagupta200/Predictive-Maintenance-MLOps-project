name: Drift Monitoring (Auto-Rollback)

on:
  workflow_dispatch:
    inputs:
      cluster_name:
        description: "EKS cluster name (optional; if empty, uses secret EKS_CLUSTER_NAME)"
        required: false
        type: string
      namespace:
        description: "Kubernetes namespace"
        required: true
        default: "default"
        type: string
      deployment_name:
        description: "Kubernetes Deployment to rollback"
        required: true
        default: "predictive-maintenance-api"
        type: string
      simulate_drift:
        description: "For demo/testing: create drifted current dataset to force PSI breach"
        required: true
        default: "true"
        type: choice
        options: ["true", "false"]
      psi_threshold:
        description: "PSI drift threshold"
        required: true
        default: "0.2"
        type: string
      destroy_cluster_after_test:
        description: "Demo only: after rollback, delete EKS cluster (only pm-debug-* allowed in rollback.yml)"
        required: true
        default: "true"
        type: choice
        options: ["true", "false"]
      bootstrap_eks_access:
        description: "Let rollback workflow auto-fix EKS access (recommended for demo)"
        required: true
        default: "true"
        type: choice
        options: ["true", "false"]

permissions:
  contents: read
  actions: read

jobs:
  drift-check:
    runs-on: ubuntu-latest
    env:
      DRIFT_PSI_THRESHOLD: ${{ inputs.psi_threshold }}
      SIMULATE_DRIFT: ${{ inputs.simulate_drift }}
      CLUSTER_FOR_ROLLBACK: ${{ inputs.cluster_name != '' && inputs.cluster_name || secrets.EKS_CLUSTER_NAME }}
      NS_FOR_ROLLBACK: ${{ inputs.namespace }}
      DEPLOY_FOR_ROLLBACK: ${{ inputs.deployment_name }}
      DESTROY_AFTER: ${{ inputs.destroy_cluster_after_test }}
      BOOTSTRAP: ${{ inputs.bootstrap_eks_access }}

    steps:
      - uses: actions/checkout@v4

      - name: Find latest successful ci-cd run (this branch)
        id: findrun
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const workflow_id = 'ci-cd.yaml';
            const branch = context.ref.replace('refs/heads/', '');
            const runs = await github.rest.actions.listWorkflowRuns({
              owner, repo, workflow_id, branch, status: 'completed', per_page: 50
            });
            const good = runs.data.workflow_runs.find(r => r.conclusion === 'success');
            if (!good) core.setFailed(`No successful ${workflow_id} run found on branch ${branch}`);
            core.setOutput('run_id', String(good.id));

      - name: Download post-deploy-data (train/val/meta) from that run
        uses: actions/download-artifact@v4
        with:
          name: post-deploy-data
          run-id: ${{ steps.findrun.outputs.run_id }}
          github-token: ${{ github.token }}
          path: .post_deploy_data

      - name: Place train/val into artifacts/processed
        run: |
          set -euo pipefail
          mkdir -p artifacts/processed
          # handle either layout (artifact root or nested artifacts/processed)
          if [ -f .post_deploy_data/train.csv ]; then
            cp .post_deploy_data/train.csv artifacts/processed/train.csv
          else
            cp .post_deploy_data/artifacts/processed/train.csv artifacts/processed/train.csv
          fi

          if [ -f .post_deploy_data/val.csv ]; then
            cp .post_deploy_data/val.csv artifacts/processed/val.csv
          else
            cp .post_deploy_data/artifacts/processed/val.csv artifacts/processed/val.csv
          fi

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install evidently pandas numpy

      - name: Install jq (for dispatch payload)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Prepare current dataset (optionally drifted)
        run: |
          set -euo pipefail
          python - <<'PY'
          import os
          import numpy as np
          import pandas as pd
          from pathlib import Path

          cur = Path("artifacts/processed/val.csv")
          out = Path("reports/current_for_drift_check.csv")
          out.parent.mkdir(parents=True, exist_ok=True)

          df = pd.read_csv(cur)
          simulate = (os.getenv("SIMULATE_DRIFT","false").lower() == "true")
          if simulate:
            num = df.select_dtypes(include=[np.number]).columns
            for c in num:
              df[c] = df[c] * 3.0 + 50.0
          df.to_csv(out, index=False)
          print("Wrote:", out, "simulate_drift=", simulate)
          PY

      - name: Run drift check (PSI gate)
        id: drift
        continue-on-error: true
        run: |
          set -euo pipefail
          python scripts/drift_check.py \
            --reference artifacts/processed/train.csv \
            --current reports/current_for_drift_check.csv \
            --out_dir reports

      - name: Upload drift reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: drift-reports
          path: reports/

      - name: Trigger automated rollback (repository_dispatch)
        if: steps.drift.outcome != 'success' && env.CLUSTER_FOR_ROLLBACK != ''
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          reason="PSI drift breached threshold=${DRIFT_PSI_THRESHOLD} (see drift-reports artifact)"
          payload=$(jq -n \
            --arg reason "$reason" \
            --arg cluster_name "${CLUSTER_FOR_ROLLBACK}" \
            --arg namespace "${NS_FOR_ROLLBACK}" \
            --arg deployment_name "${DEPLOY_FOR_ROLLBACK}" \
            --arg destroy_cluster_after_test "${DESTROY_AFTER}" \
            --arg bootstrap_eks_access "${BOOTSTRAP}" \
            '{event_type:"model_degraded",
              client_payload:{
                reason:$reason,
                cluster_name:$cluster_name,
                namespace:$namespace,
                deployment_name:$deployment_name,
                destroy_cluster_after_test:$destroy_cluster_after_test,
                bootstrap_eks_access:$bootstrap_eks_access
              }
            }')
          curl -sSf -X POST \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/dispatches" \
            -d "${payload}"

      - name: Fail workflow if drift detected
        if: steps.drift.outcome != 'success'
        run: |
          echo "Drift detected; rollback dispatched."
          exit 1
