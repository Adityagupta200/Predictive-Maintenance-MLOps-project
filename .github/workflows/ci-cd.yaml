name: ci-cd

on:
  push:
    branches: [master]
    paths:
      - "src/**"
      - "infra/**"
      - "k8s/**"
      - "dvc.yaml"
      - "params.yaml"
      - ".github/**"
      - "requirements*.txt"
  pull_request:
    branches: [master]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"

  # MLflow & gating defaults (point 1 in PDF)
  MLFLOW_TRACKING_URI: "file:./mlruns"
  MLFLOW_EXPERIMENT_NAME: "cmapss_rul_xgb_optuna"
  METRIC_NAME: "r2"
  METRIC_MODE: "max"
  METRIC_THRESHOLD: "0.90"
  METRICS_PATH: "artifacts/metrics/metrics.json"

jobs:
  test-train-validate:
    runs-on: ubuntu-latest
    env:
      MLFLOW_TRACKING_URI: "file:./mlruns"
      MLFLOW_EXPERIMENT_NAME: "cmapss_rul_xgb_optuna"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          if [ -f requirements-api.txt ]; then pip install -r requirements-api.txt; fi
          pip install pytest

      - name: Add src to PYTHONPATH
        run: echo "PYTHONPATH=$PWD/src" >> "$GITHUB_ENV"

      - name: Debug repo tree
        run: |
          pwd
          ls -la
          ls -la src || true
          ls -la src/api || true

      - name: Run unit tests (PyTest)
        run: pytest -q

      - name: Run DVC pipeline (train + validate)
        run: dvc repro

      - name: Verify model artifact exists
        run: |
          ls -la models || true
          test -f models/best_model.joblib

      - name: Upload model artifact for deploy
        uses: actions/upload-artifact@v4
        with:
          name: model-artifact
          path: models/best_model.joblib
          if-no-files-found: error

      - name: Enforce quality gate
        env:
          MLFLOW_TRACKING_URI: "file:./mlruns"
          MLFLOW_EXPERIMENT_NAME: "cmapss_rul_xgb_optuna"
          METRIC_NAME: "${{ env.METRIC_NAME }}"
          METRIC_MODE: "${{ env.METRIC_MODE }}"
          METRIC_THRESHOLD: "${{ env.METRIC_THRESHOLD }}"
          METRICS_PATH: "${{ env.METRICS_PATH }}"
        run: python .github/scripts/check_accuracy_gate.py

  deploy:
    needs: test-train-validate
    if: needs.test-train-validate.result == 'success'
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ap-south-1
      EKS_CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
      IMAGE_TAG: ${{ github.sha }}
      IMAGE_REPO: ${{ secrets.DOCKER_IMAGE_REPO }}
      K8S_NAMESPACE: default
      DEPLOYMENT_NAME: predictive-mastertenance-api

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download model artifact
        uses: actions/download-artifact@v4
        with:
          name: model-artifact
          path: .github_artifacts

      - name: Place model into Docker build context
        run: |
          set -euo pipefail
          mkdir -p models
          if [ -f .github_artifacts/models/best_model.joblib ]; then
            cp .github_artifacts/models/best_model.joblib models/best_model.joblib
          elif [ -f .github_artifacts/best_model.joblib ]; then
            cp .github_artifacts/best_model.joblib models/best_model.joblib
          else
            echo "Downloaded artifact contents:"
            ls -R .github_artifacts
            exit 1
          fi
          test -f models/best_model.joblib

      - name: Log in to Docker registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push image
        id: build
        run: |
          set -euo pipefail
          IMAGE="${IMAGE_REPO}:${IMAGE_TAG}"
          docker build -f infra/docker/DockerFile -t "$IMAGE" .
          docker push "$IMAGE"
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "v1.30.0"

      - name: Configure kubectl for EKS
        run: |
          set -euo pipefail
          aws eks update-kubeconfig \
            --name "${EKS_CLUSTER_NAME}" \
            --region "${AWS_REGION}"

      - name: Deploy new version to Kubernetes
        run: |
          set -euo pipefail
          IMAGE="${{ steps.build.outputs.image }}"
          kubectl -n "${K8S_NAMESPACE}" set image deployment/${DEPLOYMENT_NAME} \
            api="$IMAGE"
          kubectl -n "${K8S_NAMESPACE}" rollout status \
            deployment/${DEPLOYMENT_NAME} --timeout=600s

      - name: Debug rollout failure
        if: failure()
        run: |
          set -euo pipefail
          kubectl -n "${K8S_NAMESPACE}" get deploy "${DEPLOYMENT_NAME}" -o wide || true
          kubectl -n "${K8S_NAMESPACE}" describe deploy "${DEPLOYMENT_NAME}" || true
          kubectl -n "${K8S_NAMESPACE}" get rs -l app="${DEPLOYMENT_NAME}" -o wide || true
          kubectl -n "${K8S_NAMESPACE}" get pods -l app="${DEPLOYMENT_NAME}" -o wide || true
          kubectl -n "${K8S_NAMESPACE}" describe pods -l app="${DEPLOYMENT_NAME}" || true
          kubectl -n "${K8S_NAMESPACE}" logs -l app="${DEPLOYMENT_NAME}" --all-containers=true --tail=200 || true
